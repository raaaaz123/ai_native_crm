rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Contacts collection - users can only access their own contacts
    match /contacts/{contactId} {
      allow read, write, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Deals collection - users can only access their own deals
    match /deals/{dealId} {
      allow read, write, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Activities collection - users can only access their own activities
    match /activities/{activityId} {
      allow read, write, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    
    // Chat widgets - allow authenticated users to access widgets
    match /chatWidgets/{widgetId} {
      allow read, write, delete: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Chat conversations - allow authenticated users to access conversations
    match /chatConversations/{conversationId} {
      allow read, write, delete: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Chat messages - accessible by conversation participants
    match /chatMessages/{messageId} {
      allow read, write: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Knowledge base - allow authenticated users to access knowledge base
    match /knowledgeBase/{itemId} {
      allow read, write, delete: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Allow collection-level queries for knowledge base
    match /knowledgeBase/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Scraped websites - allow authenticated users to access scraped data
    match /scraped_websites/{itemId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Allow collection-level queries for scraped websites
    match /scraped_websites/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Allow collection-level queries for review forms
    match /reviewForms/{document=**} {
      allow read: if true; // Allow public access for form submission
    }
    
    // Allow collection-level queries for review submissions
    match /reviewSubmissions/{document=**} {
      allow read: if request.auth != null; // Only authenticated users can query submissions
    }
    
    // Review forms - company members can manage their company's forms, public can read for submission
    match /reviewForms/{formId} {
      allow read: if true; // Allow public access to read forms for submission
      allow write, delete: if request.auth != null && 
        exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/companyMembers/$(request.auth.uid)).data.companyId == resource.data.businessId;
      allow create: if request.auth != null && 
        exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/companyMembers/$(request.auth.uid)).data.companyId == request.resource.data.businessId;
    }
    
    // Review submissions - company members can access their company's form submissions
    match /reviewSubmissions/{submissionId} {
      allow read, write, delete: if request.auth != null && 
        exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/companyMembers/$(request.auth.uid)).data.companyId == resource.data.businessId;
      allow create: if true; // Allow anyone to create submissions (for anonymous submissions)
    }
    
    // Companies - company members can access their company
    match /companies/{companyId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && 
        exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/companyMembers/$(request.auth.uid)).data.companyId == companyId;
      allow create: if request.auth != null;
    }
    
    // Company members - members can access their own membership, admins can manage all
    match /companyMembers/{memberId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         (exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/companyMembers/$(request.auth.uid)).data.role == 'admin'));
      allow write, delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid ||
         (exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/companyMembers/$(request.auth.uid)).data.role == 'admin'));
      allow create: if request.auth != null;
    }
    
    // Company invites - accessible by invited email and authenticated users
    match /companyInvites/{inviteId} {
      // Anyone with the email can read their own invitation
      allow read: if request.auth != null && 
        (resource.data.email == request.auth.token.email || request.auth != null);
      
      // Any authenticated user can update/delete (backend validation handles permissions)
      // We rely on backend updateInvite() function to validate admin status
      allow update: if request.auth != null && 
        resource.data.status == 'pending'; // Can only update pending invitations
      
      allow delete: if request.auth != null;
      
      // Any authenticated user can create invitations (backend validates permissions)
      allow create: if request.auth != null;
    }
    
    // Allow collection-level queries for company-related collections
    match /companyMembers/{document=**} {
      allow read: if request.auth != null;
    }
    
    match /companyInvites/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Workspace collections - new workspace system
    match /workspaces/{workspaceId} {
      // Allow read if user is a member of the workspace
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + workspaceId));
      
      // Allow write/delete if user is owner or admin of the workspace
      allow write, delete: if request.auth != null && 
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + workspaceId)) &&
        get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + workspaceId)).data.role in ['owner', 'admin'];
      
      // Allow create for any authenticated user (for initial workspace creation)
      allow create: if request.auth != null;
    }
    
    // Allow collection-level queries for workspaces (for URL checking)
    match /workspaces/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Workspace members - simplified rules for easier workspace creation
    match /workspace_members/{memberId} {
      // Allow read if user is the member or has access to the workspace
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         (exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)) &&
          get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)).data.role in ['owner', 'admin']));
      
      // Allow write/delete if user is the member or has admin access
      allow write, delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid ||
         (exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)) &&
          get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)).data.role in ['owner', 'admin']));
      
      // Allow create for any authenticated user (simplified for workspace creation)
      allow create: if request.auth != null;
    }
    
    // Workspace invites - accessible by invited email and workspace members
    match /workspace_invites/{inviteId} {
      allow read: if request.auth != null && 
        (resource.data.email == request.auth.token.email || 
         (exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)) &&
          get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)).data.role in ['owner', 'admin']));
      
      allow update: if request.auth != null && 
        resource.data.status == 'pending' && 
        resource.data.email == request.auth.token.email;
      
      allow delete: if request.auth != null && 
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)) &&
        get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)).data.role in ['owner', 'admin'];
      
      allow create: if request.auth != null && 
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + request.resource.data.workspaceId)) &&
        get(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + request.resource.data.workspaceId)).data.role in ['owner', 'admin'];
    }
    
    // Allow collection-level queries for workspace-related collections
    match /workspace_members/{document=**} {
      allow read: if request.auth != null;
    }
    
    match /workspace_invites/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Agents collection - workspace members can access their workspace's agents
    match /agents/{agentId} {
      // Allow public read for active agents (needed for public chat widgets)
      allow read: if resource.data.status == 'active' ||
        (request.auth != null &&
         exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId)));

      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + resource.data.workspaceId));

      // Allow create if user is a member of the workspace
      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + request.resource.data.workspaceId));
    }
    
    // Allow collection-level queries for agents
    match /agents/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Agent Channels collection - workspace members can access channels for their workspace's agents
    match /agentChannels/{channelId} {
      // Allow public read for active channels (needed for public chat widgets/iframes)
      allow read: if resource.data.isActive == true ||
        (request.auth != null &&
         resource.data.agentId != null &&
         exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
         exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId)));

      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null &&
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));

      // Allow create if user is a member of the workspace (check via agent's workspaceId from request)
      allow create: if request.auth != null &&
        request.resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(request.resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(request.resource.data.agentId)).data.workspaceId));
    }
    
    // Allow collection-level queries for agentChannels
    match /agentChannels/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Agent Knowledge collection - workspace members can access knowledge for their workspace's agents
    match /agentKnowledge/{knowledgeId} {
      // Allow read if user is a member of the workspace
      allow read: if request.auth != null && 
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));
      
      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null && 
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));
      
      // Allow create if user is a member of the workspace
      allow create: if request.auth != null && 
        request.resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(request.resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(request.resource.data.agentId)).data.workspaceId));
    }
    
    // Allow collection-level queries for agentKnowledge
    match /agentKnowledge/{document=**} {
      allow read: if request.auth != null;
    }
    
    // Conversations collection - workspace members can access conversations for their workspace's agents
    match /conversations/{conversationId} {
      // Allow public read/write for active agents (needed for public chat widgets)
      allow read, write, create: if resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.status == 'active';
      
      // Allow read if user is authenticated and conversation belongs to their workspace's agent
      allow read: if request.auth != null && 
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));
      
      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null && 
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));
      
      // Allow create if user is a member of the workspace OR for public chat widgets with active agents
      allow create: if (request.auth != null && 
        request.resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(request.resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(request.resource.data.agentId)).data.workspaceId))) ||
        (request.resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(request.resource.data.agentId)) &&
        get(/databases/$(database)/documents/agents/$(request.resource.data.agentId)).data.status == 'active');
    }
    
    // Allow collection-level queries for conversations - allow public queries for active agents
    match /conversations/{document=**} {
      allow read: if true; // Allow public read for collection queries (needed for chat widgets)
    }
    
    // Messages collection - workspace members can access messages for conversations in their workspace
    match /messages/{messageId} {
      // Allow public read/write for messages with agentId that belongs to active agents (needed for public chat widgets)
      allow read, write, create: if resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.status == 'active';
      
      // Allow public read/write for messages being created with agentId that belongs to active agents
      allow create: if request.resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(request.resource.data.agentId)) &&
        get(/databases/$(database)/documents/agents/$(request.resource.data.agentId)).data.status == 'active';
      
      // Allow read if user is authenticated and message belongs to a conversation in their workspace
      allow read: if request.auth != null && 
        resource.data.conversationId != null &&
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.agentId)).data.workspaceId));
      
      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null && 
        resource.data.conversationId != null &&
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.agentId)).data.workspaceId));
      
      // Allow create if user is a member of the workspace
      allow create: if request.auth != null && 
        request.resource.data.conversationId != null &&
        exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)) &&
        get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.agentId)).data.workspaceId));
    }
    
    // Allow collection-level queries for messages - allow public queries for active agents
    match /messages/{document=**} {
      allow read: if true; // Allow public read for collection queries (needed for chat widgets)
    }

    // Notion Connections - workspace members can manage their workspace's Notion connections
    match /notionConnections/{connectionId} {
      // Allow read if user is authenticated (simplified for easier access)
      allow read: if request.auth != null;

      // Allow write/delete if user is authenticated
      allow write, delete: if request.auth != null;

      // Allow create if user is authenticated
      allow create: if request.auth != null;
    }

    // Allow collection-level queries for notionConnections
    match /notionConnections/{document=**} {
      allow read: if request.auth != null;
    }

    // Google Sheets Connections - workspace members can manage their workspace's Google Sheets connections
    // Connection ID format: {workspaceId}_google_sheets
    match /googleSheetsConnections/{connectionId} {
      // Extract workspaceId from connectionId (format: workspaceId_google_sheets)
      // Allow read if user is a member of the workspace
      allow read: if request.auth != null && 
        connectionId.matches('.*_google_sheets$') &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + connectionId.replace('_google_sheets', '')));

      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null && 
        connectionId.matches('.*_google_sheets$') &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + connectionId.replace('_google_sheets', '')));

      // Allow create if user is a member of the workspace (check via resource data)
      allow create: if request.auth != null && 
        request.resource.data.workspaceId != null &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + request.resource.data.workspaceId));
    }

    // Allow collection-level queries for googleSheetsConnections
    match /googleSheetsConnections/{document=**} {
      allow read: if request.auth != null;
    }

    // Agent Actions collection - workspace members can access actions for their workspace's agents
    match /agentActions/{actionId} {
      // Allow read if user is a member of the workspace that owns the agent
      allow read: if request.auth != null && 
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));
      
      // Allow write/delete if user is a member of the workspace
      allow write, delete: if request.auth != null && 
        resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(resource.data.agentId)).data.workspaceId));
      
      // Allow create if user is a member of the workspace
      allow create: if request.auth != null && 
        request.resource.data.agentId != null &&
        exists(/databases/$(database)/documents/agents/$(request.resource.data.agentId)) &&
        exists(/databases/$(database)/documents/workspace_members/$(request.auth.uid + '_' + get(/databases/$(database)/documents/agents/$(request.resource.data.agentId)).data.workspaceId));
    }
    
    // Allow collection-level queries for agentActions
    match /agentActions/{document=**} {
      allow read: if request.auth != null;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
