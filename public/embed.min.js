// Rexa Chat Widget Embed Script
// Lightweight script to render a floating chat button and iframe
// Usage (example):
// <script src="/embed.min.js" id="CHANNEL_ID" data-agent-id="AGENT_ID" data-workspace="WORKSPACE_SLUG" data-base-url="https://ai-native-crm.vercel.app" data-position="bottom-right" data-theme="light"></script>

(function () {
  try {
    var currentScript = document.currentScript;
    if (!currentScript) {
      // Try to locate the script by a src match
      currentScript = document.querySelector('script[src*="embed.min.js"]');
    }
    if (!currentScript) {
      console.warn('[RexaChat] embed script element not found.');
      return;
    }

    // Read config from data attributes
    var channelId = currentScript.getAttribute('id') || currentScript.getAttribute('data-channel-id') || 'CHANNEL_ID';
    var agentId = currentScript.getAttribute('data-agent-id') || '';
    var workspaceSlug = currentScript.getAttribute('data-workspace') || '';
    var baseUrl = currentScript.getAttribute('data-base-url') || window.location.origin;
    var position = (currentScript.getAttribute('data-position') || 'bottom-right').toLowerCase();
    var theme = (currentScript.getAttribute('data-theme') || 'light').toLowerCase();

    if (!agentId || !workspaceSlug || !channelId) {
      console.warn('[RexaChat] Missing required attributes: data-agent-id, data-workspace, or CHANNEL id');
    }

    // State
    var isOpen = false;
    var buttonEl = null;
    var iframeEl = null;
    var wrapperEl = null;
    var notificationDotEl = null;

    // Basic styles
    var primaryColor = '#2563eb';
    var isDark = theme === 'dark';

    function applyButtonPosition(style) {
      style.position = 'fixed';
      style.zIndex = '999999';
      style.width = '56px';
      style.height = '56px';
      style.borderRadius = '50%';
      style.border = 'none';
      style.cursor = 'pointer';
      style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)';
      style.backgroundColor = primaryColor;
      style.color = '#fff';
      style.display = 'flex';
      style.alignItems = 'center';
      style.justifyContent = 'center';
      style.transition = 'transform 0.15s ease, box-shadow 0.15s ease';

      if (position.indexOf('bottom') !== -1) {
        style.bottom = '24px';
      } else {
        style.top = '24px';
      }
      if (position.indexOf('right') !== -1) {
        style.right = '24px';
      } else {
        style.left = '24px';
      }
    }

    function createNotificationDot() {
      var dot = document.createElement('div');
      dot.style.position = 'absolute';
      dot.style.top = '0';
      dot.style.right = '0';
      dot.style.width = '12px';
      dot.style.height = '12px';
      dot.style.borderRadius = '50%';
      dot.style.background = '#ef4444';
      dot.style.boxShadow = '0 0 0 2px #fff';
      dot.style.transform = 'translate(25%, -25%)';
      dot.style.display = 'none';
      return dot;
    }

    function createButton() {
      if (document.getElementById('rexa-chat-button')) return;
      var btn = document.createElement('button');
      btn.id = 'rexa-chat-button';
      applyButtonPosition(btn.style);
      btn.setAttribute('aria-label', 'Open chat');

      // Icon (SVG)
      btn.innerHTML = '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4v8z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>';

      btn.addEventListener('mouseenter', function () {
        btn.style.transform = 'scale(1.05)';
        btn.style.boxShadow = '0 12px 30px rgba(0,0,0,0.2)';
      });
      btn.addEventListener('mouseleave', function () {
        btn.style.transform = 'scale(1)';
        btn.style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)';
      });
      btn.addEventListener('click', toggle);

      // Notification dot
      notificationDotEl = createNotificationDot();
      btn.appendChild(notificationDotEl);

      document.body.appendChild(btn);
      buttonEl = btn;
    }

    function createIframeWrapper() {
      if (document.getElementById('rexa-chat-wrapper')) return;
      var wrapper = document.createElement('div');
      wrapper.id = 'rexa-chat-wrapper';
      wrapper.style.position = 'fixed';
      wrapper.style.zIndex = '999998';
      wrapper.style.borderRadius = '16px';
      wrapper.style.overflow = 'hidden';
      wrapper.style.boxShadow = '0 20px 40px rgba(0,0,0,0.25)';

      // Position near the button
      if (position.indexOf('bottom') !== -1) {
        wrapper.style.bottom = '92px';
      } else {
        wrapper.style.top = '92px';
      }
      if (position.indexOf('right') !== -1) {
        wrapper.style.right = '24px';
      } else {
        wrapper.style.left = '24px';
      }

      // Sizing based on viewport
      var vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
      var isMobile = vw < 768;
      if (isMobile) {
        wrapper.style.width = '100vw';
        wrapper.style.height = '100vh';
        wrapper.style.borderRadius = '0px';
        wrapper.style.bottom = '0';
        wrapper.style.right = '0';
        wrapper.style.left = '0';
        wrapper.style.top = '0';
      } else {
        wrapper.style.width = '384px';
        wrapper.style.height = '600px';
      }

      var iframe = document.createElement('iframe');
      iframe.id = 'rexa-chat-iframe';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      iframe.style.background = isDark ? '#0a0a0a' : '#ffffff';
      iframe.setAttribute('allow', 'clipboard-write; microphone; camera');
      iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups');
      iframe.src = baseUrl.replace(/\/$/, '') + '/chat/' + encodeURIComponent(workspaceSlug) + '/' + encodeURIComponent(agentId) + '/' + encodeURIComponent(channelId);

      wrapper.appendChild(iframe);
      document.body.appendChild(wrapper);
      iframeEl = iframe;
      wrapperEl = wrapper;

      // Close button for mobile overlay
      if (isMobile) {
        var closeBtn = document.createElement('button');
        closeBtn.setAttribute('aria-label', 'Close chat');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.position = 'fixed';
        closeBtn.style.top = '16px';
        closeBtn.style.right = position.indexOf('right') !== -1 ? '16px' : 'auto';
        closeBtn.style.left = position.indexOf('right') !== -1 ? 'auto' : '16px';
        closeBtn.style.zIndex = '1000000';
        closeBtn.style.width = '36px';
        closeBtn.style.height = '36px';
        closeBtn.style.borderRadius = '8px';
        closeBtn.style.border = 'none';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.background = isDark ? '#262626' : '#ffffff';
        closeBtn.style.color = isDark ? '#f5f5f5' : '#0a0a0a';
        closeBtn.style.boxShadow = '0 8px 20px rgba(0,0,0,0.2)';
        closeBtn.addEventListener('click', close);
        document.body.appendChild(closeBtn);
      }
    }

    function open() {
      if (isOpen) return;
      createIframeWrapper();
      isOpen = true;
    }

    function close() {
      if (!isOpen) return;
      if (wrapperEl) {
        try { document.body.removeChild(wrapperEl); } catch (e) {}
      }
      wrapperEl = null;
      iframeEl = null;
      isOpen = false;
    }

    function toggle() { isOpen ? close() : open(); }

    function showNotification() {
      if (notificationDotEl) notificationDotEl.style.display = 'block';
    }

    function hideNotification() {
      if (notificationDotEl) notificationDotEl.style.display = 'none';
    }

    function isChatOpen() { return !!isOpen; }

    // Initialize global API proxy queue if not present
    if (!window.rexaChat || window.rexaChat('getState') !== 'initialized') {
      var qfn = function () {
        if (!window.rexaChat.q) { window.rexaChat.q = []; }
        window.rexaChat.q.push(arguments);
      };
      window.rexaChat = new Proxy(qfn, {
        get: function (target, prop) {
          if (prop === 'q') return target.q;
          return function () { return target(prop, arguments); };
        }
      });
    }

    // Replace proxy with actual implementation
    window.rexaChat = function (method) {
      switch (method) {
        case 'init':
          createButton();
          return true;
        case 'open':
          open();
          return true;
        case 'close':
          close();
          return true;
        case 'toggle':
          toggle();
          return true;
        case 'showNotification':
          showNotification();
          return true;
        case 'hideNotification':
          hideNotification();
          return true;
        case 'isOpen':
          return isChatOpen();
        case 'getState':
          return 'initialized';
        default:
          console.warn('[RexaChat] Unknown method:', method);
          return false;
      }
    };

    // Auto-init on load
    var init = function () {
      createButton();
    };

    if (document.readyState === 'complete') {
      init();
    } else {
      window.addEventListener('load', init);
    }
  } catch (err) {
    console.error('[RexaChat] Failed to initialize:', err);
  }
})();